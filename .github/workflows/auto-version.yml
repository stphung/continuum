name: Auto Version

on:
  workflow_run:
    workflows: ["Continuum CI/CD"]
    types: [completed]
    branches: [main]

jobs:
  bump-version:
    name: Automatic Version Bump
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # Use GITHUB_TOKEN for version commits
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for version skip
        id: check_skip
        run: |
          # Check if the latest commit message contains [skip-version]
          COMMIT_MSG=$(git log -1 --pretty=%B)
          if [[ "$COMMIT_MSG" == *"[skip-version]"* ]]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "⏭️ Skipping version bump due to [skip-version] in commit message"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "✅ Proceeding with automatic version bump"
          fi

      - name: Bump version and push tag
        if: steps.check_skip.outputs.skip == 'false'
        uses: anothrNick/github-tag-action@1.67.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEFAULT_BUMP: patch
          WITH_V: true
          RELEASE_BRANCHES: main
          DRY_RUN: false
          VERBOSE: true
          PRERELEASE: false
          INITIAL_VERSION: 1.1.0

      - name: Version bump summary
        if: steps.check_skip.outputs.skip == 'false'
        run: |
          echo "🚀 **Automatic Version Bump Completed**"
          echo "- New version tag created and pushed"
          echo "- Release workflow will be triggered automatically"
          echo "- Multi-platform builds (including Android APK) will be generated"
          echo ""
          echo "💡 **Tips:**"
          echo "- Use '[skip-version]' in commit message to skip auto-versioning"
          echo "- Use '#major' or '#minor' in commit message for bigger version bumps"
          echo "- Manual tags (git tag vX.Y.Z) will override automatic versioning"